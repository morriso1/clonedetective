---

title: Example nuclei segmentation using StarDist


keywords: fastai
sidebar: home_sidebar



nb_path: "04_Tutorial_StarDist_segmentation.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 04_Tutorial_StarDist_segmentation.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>
<span class="kn">import</span> <span class="nn">napari</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">csbdeep.utils</span> <span class="kn">import</span> <span class="n">normalize</span>
<span class="kn">from</span> <span class="nn">dask</span> <span class="kn">import</span> <span class="n">delayed</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">io</span>
<span class="kn">from</span> <span class="nn">stardist.models</span> <span class="kn">import</span> <span class="n">StarDist2D</span>
<span class="kn">from</span> <span class="nn">stardist.plot</span> <span class="kn">import</span> <span class="n">render_label</span>
<span class="kn">import</span> <span class="nn">dask</span>

<span class="kn">from</span> <span class="nn">py_clone_detective</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">py_clone_detective.clone_counters</span> <span class="kn">import</span> <span class="n">LazyCloneCounter</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">foo</span> <span class="o">=</span> <span class="n">LazyCloneCounter</span><span class="p">(</span><span class="s2">&quot;trying_stardist&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;a\dg\d\d?p\d&quot;</span><span class="p">,</span> <span class="mf">0.275</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">foo</span><span class="o">.</span><span class="n">add_images</span><span class="p">(</span>
    <span class="n">C0</span><span class="o">=</span><span class="s2">&quot;../current_imaging_analysis/MARCM2A_E7F1_refactoring/C0/C0_imgs/*.tif*&quot;</span><span class="p">,</span>
    <span class="n">C1</span><span class="o">=</span><span class="s2">&quot;../current_imaging_analysis/MARCM2A_E7F1_refactoring/C1/C1_imgs/*.tif*&quot;</span><span class="p">,</span>
    <span class="n">C2</span><span class="o">=</span><span class="s2">&quot;../current_imaging_analysis/MARCM2A_E7F1_refactoring/C2/C2_imgs/*.tif*&quot;</span><span class="p">,</span>
    <span class="n">C3</span><span class="o">=</span><span class="s2">&quot;../current_imaging_analysis/MARCM2A_E7F1_refactoring/C3/C3_imgs/*.tif*&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">StarDist2D</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;2D_versatile_fluo&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Found model &#39;2D_versatile_fluo&#39; for &#39;StarDist2D&#39;.
Loading network weights from &#39;weights_best.h5&#39;.
Loading thresholds from &#39;thresholds.json&#39;.
Using default values: prob_thresh=0.479071, nms_thresh=0.3.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2021-08-03 09:42:49.228354: I tensorflow/core/platform/cpu_feature_guard.cc:142] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">map_stardist</span><span class="p">(</span><span class="n">img_4d</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img_4d</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="n">seg</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_instances</span><span class="p">(</span><span class="n">normalize</span><span class="p">(</span><span class="n">img</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">seg</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bar</span> <span class="o">=</span> <span class="n">foo</span><span class="o">.</span><span class="n">image_data</span><span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">map_blocks</span><span class="p">(</span><span class="n">map_stardist</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">labels_xarr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
    <span class="n">bar</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">foo</span><span class="o">.</span><span class="n">image_data</span><span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">foo</span><span class="o">.</span><span class="n">image_data</span><span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span>
<span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;img_channels&quot;</span><span class="p">:</span> <span class="s2">&quot;seg_channels&quot;</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">save_stardist_seg</span><span class="p">(</span><span class="n">xarr_3d</span><span class="p">,</span> <span class="n">fp</span><span class="p">):</span>
    <span class="n">l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">xarr_3d</span><span class="p">:</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delayed</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">imsave</span><span class="p">)(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">fp</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;img_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">),</span>
            <span class="n">img</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="p">))</span>
    <span class="k">return</span> <span class="n">l</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">d_saves</span> <span class="o">=</span> <span class="n">save_stardist_seg</span><span class="p">(</span><span class="n">labels_xarr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;C0_stardist_segs&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">d_saves</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;C0_stardist_segs&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;a2g09p2.tif&#39;,
 &#39;a2g10p3.tif&#39;,
 &#39;a2g12p1.tif&#39;,
 &#39;a1g04p1.tif&#39;,
 &#39;a2g10p2.tif&#39;,
 &#39;a2g09p3.tif&#39;,
 &#39;a2g09p1.tif&#39;,
 &#39;a1g04p3.tif&#39;,
 &#39;a2g12p2.tif&#39;,
 &#39;a1g06p1.tif&#39;,
 &#39;a1g04p2.tif&#39;,
 &#39;a2g10p1.tif&#39;,
 &#39;a1g02p1.tif&#39;,
 &#39;a1g02p3.tif&#39;,
 &#39;a1g02p2.tif&#39;,
 &#39;a2g13p2.tif&#39;,
 &#39;a1g07p1.tif&#39;,
 &#39;a1g05p3.tif&#39;,
 &#39;a2g08p1.tif&#39;,
 &#39;a1g05p2.tif&#39;,
 &#39;a2g11p1.tif&#39;,
 &#39;a2g13p3.tif&#39;,
 &#39;a2g13p1.tif&#39;,
 &#39;a1g07p2.tif&#39;,
 &#39;a2g11p3.tif&#39;,
 &#39;a2g08p2.tif&#39;,
 &#39;a2g08p3.tif&#39;,
 &#39;a1g05p1.tif&#39;,
 &#39;a2g11p2.tif&#39;,
 &#39;a1g07p3.tif&#39;,
 &#39;a1g03p3.tif&#39;,
 &#39;a1g01p1.tif&#39;,
 &#39;a1g03p2.tif&#39;,
 &#39;a1g01p2.tif&#39;,
 &#39;a1g01p3.tif&#39;,
 &#39;a1g03p1.tif&#39;,
 &#39;a1g14p2.tif&#39;,
 &#39;a2g02p2.tif&#39;,
 &#39;a1g14p1.tif&#39;,
 &#39;a2g02p1.tif&#39;,
 &#39;a1g09p1.tif&#39;,
 &#39;a2g04p3.tif&#39;,
 &#39;a2g06p1.tif&#39;,
 &#39;a1g12p2.tif&#39;,
 &#39;a1g12p3.tif&#39;,
 &#39;a1g10p1.tif&#39;,
 &#39;a2g04p2.tif&#39;,
 &#39;a1g09p2.tif&#39;,
 &#39;a2g06p2.tif&#39;,
 &#39;a1g12p1.tif&#39;,
 &#39;a2g06p3.tif&#39;,
 &#39;a2g04p1.tif&#39;,
 &#39;a1g09p3.tif&#39;,
 &#39;.ipynb_checkpoints&#39;,
 &#39;a2g01p2.tif&#39;,
 &#39;a1g15p1.tif&#39;,
 &#39;a2g01p3.tif&#39;,
 &#39;a2g03p1.tif&#39;,
 &#39;a2g03p3.tif&#39;,
 &#39;a2g01p1.tif&#39;,
 &#39;a1g15p2.tif&#39;,
 &#39;a1g15p3.tif&#39;,
 &#39;a2g03p2.tif&#39;,
 &#39;a2g07p2.tif&#39;,
 &#39;a1g13p1.tif&#39;,
 &#39;a1g11p3.tif&#39;,
 &#39;a1g08p2.tif&#39;,
 &#39;a1g08p3.tif&#39;,
 &#39;a1g11p2.tif&#39;,
 &#39;a2g05p1.tif&#39;,
 &#39;a2g07p3.tif&#39;,
 &#39;a2g07p1.tif&#39;,
 &#39;a2g05p3.tif&#39;,
 &#39;a1g08p1.tif&#39;,
 &#39;a1g11p1.tif&#39;,
 &#39;a2g05p2.tif&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

