---
title: "Downstream Analysis - R"
output: html_document
---

## Recap - background and experimental aims

Our original demo dataset consisted of 67 images of the Drosophila intestine from a MARCM genetic cell lineage experiment. GFP (C1 channel) marks genetic recombination events, and so clusters of GFP positive cells define "clones" of daughter cells that over time have grown out from a single parent cell. The remaining images include DAPI (C0 channel), which ubiquitously marks all cell nuclei; PDM1 (C2 channel), which labels EnteroCyte (EC) cells; and Prospero (C3 channel), which labels EnteroEndocrine cells.

We aimed to investigate: 1) Does gene of interest regulate cell proliferation? 2) Does our gene of interest control cell differentiation? 3) Does gene of interest effect local tissue cell arrangement and structure?

We will tackle each of these experimental aims using data previously generated by clonedetective.

## Loading in data and libraries

Now we wrangle our data and plot results! Below, we do this using R tidyverse, cowplot and emmeans packages.

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(cowplot)
library(emmeans)
library(lme4)
```

```{r}
# hide
# absolute path to data
path_to_data <- "/Users/ottomorris/Documents/my_python_packages/clonedetective/data/example_results.csv"

count_df <- read_csv(path_to_data)
```

```{r}
count_df %>% head()
```

## **Cell Proliferation - number of cells per clone**

Our first aim is to determine whether there is a difference in the number of cells per clone in mutant vs control animals. `count_df` currently contains four rows for each cell - one for each of the four intensity image channels. Since we are presently interested in cell types and numbers, rather than the intensity values of individual cells, we can query count_df for a single intensity image channel. This ensures that `count_data` contains only a single row for each cell.

For simplicity, we also filter out columns not required for counting the number and type of cells per clone.

```{r}
count_df <- count_df %>%
  pivot_wider(
    names_from = int_img_ch,
    values_from = c('total_intensity', 'mean_intensity')
  ) %>% dplyr::select(matches("clone$|_pos$|int_img"))
```

Next, we groupby clones per image and sum to get the number of cells of each type per clone.

```{r}
count_df <- count_df %>%
  group_by(int_img, GFP_clone) %>%
  summarise(
    EC = sum(EC_pos),
    ECEE = sum(ECEE_pos),
    preEC = sum(preEC_pos),
    EE = sum(EE_pos),
    ISCorEB = sum(ISCorEB_pos)
  )
```

To ease downstream wrangling and plotting, we update some of the column metadata.

For example, when plotting, it will be helpful to label whether a cell is inside a clone (IC) or outside a clone (OC). This information is present within the GFP_clone column: 0 indicates if a cell is outside a clone, and \>0 indicate if a cell is inside a clone.

We also can extract metadata stored within the image names. We know that images are named 'a1' if from a wild-type (ctrl) animal, and 'a2' if from a mutant (mut) animal. The 'a\\dg\\d\\d' pattern of the image name identifies the gut (animal) from which an image is taken (e.g. 'a1g01' is ctrl animal gut 1) . Using this information, we can add 'genotype' and 'gut' columns.

```{r}
count_df <- count_df %>% mutate(
    clone_status = as.factor(if_else(GFP_clone == 0, 'OC', 'IC')),
    genotype = as.factor(if_else(str_detect(int_img, 'a1'), 'ctrl', 'mut')),
    gut = as_factor(str_extract(int_img, 'g\\d\\d')),
    total = EC + ECEE + preEC + EE + ISCorEB
  )
```

```{r}
count_df_tidy <-
  count_df %>% pivot_longer(cols = EC:ISCorEB,
                            names_to = 'cell_type',
                            values_to = 'cell_num') %>%
  mutate(cell_type = factor(cell_type, levels = c('ECEE', 'EE', 'EC', 'preEC', 'ISCorEB')))
```

```{r}
m1 <- MASS::glm.nb(total ~ genotype * clone_status,
          count_df)

summary(m1)
```

```{r}
m2 <- glmer.nb(total ~ genotype * clone_status + (1 |
                                                 gut),
            count_df)

summary(m2)
```

```{r}
library(glmmTMB)

m3 <- glmmTMB(total ~ genotype * clone_status,
              count_df,
              family = 'truncated_nbinom2')
m3 %>% summary()
```
